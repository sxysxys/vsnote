## 初步认识
- 网络层负责在不同网络之间尽力转发数据包，不管数据丢失和数据包顺序。
- 网络层是在路由器这一层，它不管数据链路层、物理层有什么协议，只负责最佳路径转包。

## 网络设备和iso参考模型的关系
- 发送端
1. 应用程序准备要传输的文件
2. 传输层将文件分段成数据包
3. 网络层将每一段加上ip地址
4. 数据链路层：使用自己的子网掩码去判断自己和目标地址在哪一个网段
   - 如果通信的计算机和本机在同一个网段（局域网），通过arp协议拿到对方的mac地址，加上帧校验，直接通过交换机传输。
   - 如果不在一个网段，由于计算机配了网关（路由器ip地址），那么就会再通过arp协议获取到路由器的mac地址，加上帧校验，再通过交换机将数据传到路由器。
5. 物理层：比特流


![](/截图/截屏2020-03-0909.13.06.png)
说设备是在哪一层的设备指的是它最高能看懂哪一层的地址。
- 路由器和交换机是不可能中病毒的，因为病毒是应用程序，是数据的内容，路由器又不执行数据只负责转包。
- 但是一台计算机中病毒了可能会一直发广播包来占用内网的带宽，也可能一直访问外网的地址来占用外网的带宽，导致其他计算机上网变慢。

## 网络层协议
网络最底层是arp协议（获取ip的对应mac地址），然后上面是ip协议（负责通过ip地址传包），再上面有icmp和iqmp协议。
### ARP协议
- 作用：在局域网内将ip地址通过广播（目标mac地址为全ff），解析相应目标ip地址的mac地址，之后计算机会将目标ip地址对应的mac地址缓存,通过`arp -a`来显示缓存的本网段的mac地址。
- arp欺骗：当某台计算机发出广播的时候，另一台非目标主机（上的某软件）可以通过发送一个随便的mac地址回原pc，这样下次再传这个ip的时候就会用这个mac地址，这样就让本应该有的通信无法进行，而且会有安全隐患。
- 防止arp欺骗：不用广播了，直接让相应的ip对应静态的mac地址。
`arp -s ip mac`

### ICMP协议
- 定义：是网络层的协议，在ip层标记了icmp，所以网络层设备会拿到ip层里的数据报进行分析，但是本质是网络层的。
- `ping`：测试网通不通
  - 返回值`TTL`:防止数据包在路由器循环，TTL减到0就不转发了
  - 还可以判断对方主机是什么系统；各系统初始TTL：`linux:64  windows:128 unix:256`
  - 通过`-i`来设置发出的ttl值，可以设成1 2，分别看沿途的第一个路由器和第二个路由器的ip地址（因为这些路由器会向主机返回ttl耗尽信息）
  - `-t`:一直ping下去
  - `-l 数字`:指定ping的数据包大小，以上都是windows的。
- 如果`ping`域名（例如baidu），发现网不通，可能是dns服务器出了问题，不一定是真的网不通，需要设置一下dns服务器的地址；如果发现设置了dns服务器的地址后，输入`www.baidu.com`，能够返回正确的百度的ip（因为dns服务器也在广域网，能返回相应ip说明网通了），那么就能确定网是通的，可能有时候沿途的路由器不让你ping；有时候发现qq能上网（没有域名，直接连目标ip），网页打不开，其实就说明了dns配置有问题，网没问题。
- 排除网络故障：`ping`一个远程服务器，如果一直出现丢包现象，那么就可以试试`ping`这个远程服务器机房里的其他服务器（局域网），如果丢包的时间都是一致的，那么就是连向机房的网的问题。
- 请求超时：发过去的数据可以通，但是数据回不来。
- `pathping`：跟踪数据包路径，计算丢包情况。可以精确到每一个路由器的丢包情况和时间。
- 所有应用：
  ![](/截图/截屏2020-04-2600.38.38.png)
- `traceroute`:windows上查看经过的沿途路由器，它是通过发送不同的具有UDP协议（服务器无相应端口）的TTL(路由器经过的最大个数)，通过沿途每个路由器TTL=0后返回的ICMP来确定路由器的地址，路由器的顺序由时间延时来确定。当到达目的主机后，由于UDP找不到相应的端口，就会返回一个特定的ICMP，这时候就不用再发了。

## IGMP协议
- 几个基本额概念
  - 点到点：一人发一人收
  - 广播：一人发，所有人收
  - 多播：多播ip地址如下图，和电视频道类似，可以在本网段接受也可以跨网段。多播不建立会话，只是一个通过多播地址发，其他多播对应的ip收。
   ![](/截图/截屏2020-03-0921.08.51.png)
- igmp协议：在路由器接口上绑定多播地址。让连接在本地局域网上的多播路由器知道是否有本局域网的主机参加了多播组。

## ip数据包的结构（使用于ip层，不适用于arp层）
![](/截图/截屏2020-03-0922.09.28.png)
- 版本：tcp/ip的版本 v4或v6
- 首部长度：首部有多少个字节
- 标志：数据是否紧急
- 总长度：整个数据包的长度
  - 数据链路层：最多1500个字节（以太网帧格式）
  - 网络层：最多65535个字节（ip数据包）
    - 如果网络层太大，那么数据链路层就会将包分成几个片。到达目的主机后，目标主机会在网络层将这些分片合成一个整包
- 标识：上述说的目标主机会将分片的包进行整合，那么目标主机是怎么知道哪些包是一个包呢？ 就是通过标识，一个大包中的小包标识是一样的。通过这个来看哪些区分不同的包
- 标志：表示这是一个分片还是一个完整的数据包
    ![](/截图/截屏2020-03-1015.29.07.png)
    其中第一位不用，第二位表示是否允许进行分片，第三位表示是否分片结束：1表示没有结束，0代表结束了
- 片偏移：这个分片的起始地址在整个大数据包的第多少个字节
- 生存时间：ttl值
- 协议号：表示数据部分是什么协议，从而决定交给谁处理
   ![](/截图/截屏2020-03-1016.28.29.png)
   - 如果是tcp/udp协议的数据就往上走，如果是网络层的协议就网络层进行处理。
   - icmp 1;igmp 2;tcp 6;udp 17;ipv6 41;ospf 89
- 首部检验和：检验首部是否有错误，不包括数据
### ipv4的使用
- 曾今的ipv4会用最后几个8/16/24位为子网码，这样固定的子网码会造成ip协议的灵活性不强，万一局域网里有300台机子，需要分配16位就太浪费了。
- 现在的ipv4协议使用了CIDR无类别域间路由选择，路由器转发表并没有规定ip数据段（第一部分）是多少位；一般都是总的isp分配给地方的isp前20位，然后地方isp可以分为8个组织或者多少个组织，这都是很灵活的。所以就会造成转发表中的每个ip长度不一致的情况，如果一个ip第一部分对应了转发表中的多个表项，那么自动取最长那个作为出口。

### ipv6的使用
ipv6设计的初衷很简单，就是为了解决地址太少的问题，它也修改了协议的部分内容，以下是几个代表性的：
- 不允许网络层设备对分组再进行分片，如果出现了链路所规定的数据长度不一致问题需要分片，那么直接将其这个分组丢弃即可，丢弃了以后想源主机发送一个ipv6类型的icmp报，通知源主机存在小分组链路，需要在ip层将分组弄小点。
- 引入了流的概念：给特殊的分组加上了标签。
- 去除了ip层的检验：因为网络层的设计者认为既然运输层和链路层都提供了检验，那么网络层属实没必要。
#### ipv6的普及
计算机网络自顶向下240。

## ip协议
路由器根据路由表选择路径，路由表由系统管理员添加的叫静态路由；路由器相互学习路由表叫动态路由，能让路由器学路由表的协议统称为ip协议。<br>
$\color{#FF0000}{路由器学习和转发数据只会看局域网网段（子网掩码），不会关心它具体的ip。}$
### 网络畅通的条件
数据发过去的时候中间有的路由器不通，那么会返回相应的路由器的地址；如果发过去通了，但是回来的时候找不到，此时就会显示请求超时。
### 静态路由
静态路由在小型网络中可以用，每添加一个网段就需要配置沿途的路由器，比较麻烦。不会随着网络的变化而自动调整。
### 动态路由
- rip协议：周期性的广播表，30s更新一次（只要连着的局域网网段就会广播）。
  ![](/截图/截屏2020-03-1021.46.17.png)
  - 当路由器连上一个网段的局域网的时候，就会对与他相连的路由器发广播，被通知的路由器收到学习后再进行不断的扩散，每扩散一个跳数加1，图中路由器c在192.168.1.0接入以后，就会收到两条路径，跳数分别是2和3，它会选择跳数为2的路径传输。
  - 如果中途有的路由线路断了，那么广播发不过去，那么与之相邻的路由就会得知信息从而不会选择这条路了，就会退而求其次选择跳数为3的。
  - 最多支持的跳数不超过15，所以不适用于网络规模太大的环境。
  - 动态路由算法：看书
- ospf协议：选择的标准不再是过了几个路由器，而是带宽。





